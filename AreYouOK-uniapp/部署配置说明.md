# 君安否小程序 - 部署配置说明

## 一、必须配置项

### 1.1 API 基础地址配置

**文件位置**：`utils/api.js`

**配置项**：
```javascript
// 第 7 行
const BASE_URL = 'https://your-api-domain.com/api'
```

**修改为实际的后端地址**：
```javascript
// 示例：
const BASE_URL = 'https://api.areyouok.com/api'
// 或开发环境：
const BASE_URL = 'http://192.168.1.100:8080/api'
```

**注意事项**：
- 生产环境必须使用 HTTPS 协议
- 不要在末尾添加斜杠 `/`
- 确保后端接口已部署并可访问

---

### 1.2 微信小程序配置

#### 1.2.1 AppID 配置

**文件位置**：`manifest.json`

找到 `mp-weixin` 配置节点，修改 `appid`：

```json
{
  "mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
      "urlCheck": false
    }
  }
}
```

**获取 AppID**：
1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入"开发" -> "开发设置"
3. 复制 "开发者ID(AppID)"

#### 1.2.2 服务器域名配置

**位置**：微信公众平台 -> 开发 -> 开发管理 -> 开发设置 -> 服务器域名

**需要配置的域名类型**：
1. **request合法域名**（必须）
   - 添加你的后端API域名
   - 例如：`https://api.areyouok.com`

2. **uploadFile合法域名**（如果需要上传功能）
   - 同上

3. **downloadFile合法域名**（如果需要下载功能）
   - 同上

**注意事项**：
- 域名必须使用 HTTPS 协议
- 域名必须备案
- 每月只能修改5次
- 开发阶段可以在微信开发者工具中勾选"不校验合法域名"

---

## 二、可选配置项

### 2.1 环境变量配置（推荐）

为了更好地管理不同环境的配置，建议创建环境变量文件。

#### 创建配置文件

**文件位置**：`utils/config.js`

```javascript
/**
 * 环境配置
 */

// 开发环境
const devConfig = {
  baseURL: 'http://192.168.1.100:8080/api',
  timeout: 10000
}

// 生产环境
const prodConfig = {
  baseURL: 'https://api.areyouok.com/api',
  timeout: 10000
}

// 根据环境选择配置
const config = process.env.NODE_ENV === 'production' ? prodConfig : devConfig

export default config
```

#### 修改 API 工具类

**文件位置**：`utils/api.js`

```javascript
import config from './config.js'

// 使用配置文件中的地址
const BASE_URL = config.baseURL
```

---

### 2.2 默认头像配置

**文件位置**：`static/default-avatar.png`

上传一个默认头像图片到 `static` 目录下，建议规格：
- 尺寸：200x200 像素
- 格式：PNG
- 背景：透明或纯色

如果不想使用图片，可以修改代码使用文字头像：

**文件位置**：`pages/user/info.vue`

```vue
<!-- 修改前 -->
<image 
  class="avatar" 
  :src="userInfo.avatarUrl || '/static/default-avatar.png'" 
  mode="aspectFill"
></image>

<!-- 修改后：使用文字头像 -->
<view class="avatar-text" v-if="!userInfo.avatarUrl">
  <text>{{ (userInfo.nickname || '用户').charAt(0) }}</text>
</view>
<image 
  class="avatar" 
  v-else
  :src="userInfo.avatarUrl" 
  mode="aspectFill"
></image>
```

---

### 2.3 版本号配置

**文件位置**：`manifest.json`

```json
{
  "name": "君安否",
  "appid": "__UNI__XXXXXX",
  "description": "每日签到，传递关怀",
  "versionName": "1.0.0",
  "versionCode": "100"
}
```

每次发布新版本时，需要同时更新：
- `versionName`：语义化版本号（如 1.0.1, 1.1.0）
- `versionCode`：整数版本号（递增）

---

## 三、微信开发者工具配置

### 3.1 项目导入

1. 打开微信开发者工具
2. 点击"导入项目"
3. 选择项目目录：`/AreYouOK-uniapp/dist/dev/mp-weixin`（开发环境）或 `/AreYouOK-uniapp/dist/build/mp-weixin`（生产环境）
4. 输入 AppID
5. 点击"导入"

### 3.2 开发阶段设置

在微信开发者工具中：

1. 点击右上角"详情"
2. 在"本地设置"中勾选：
   - ✅ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - ✅ 启用调试

3. 在"项目设置"中配置：
   - 基础库版本：建议选择最新版本
   - 增强编译：✅ 启用

---

## 四、编译和构建

### 4.1 开发环境

```bash
# 安装依赖
npm install

# 启动开发模式
npm run dev:mp-weixin
```

编译后的文件位置：`dist/dev/mp-weixin`

### 4.2 生产环境

```bash
# 构建生产版本
npm run build:mp-weixin
```

编译后的文件位置：`dist/build/mp-weixin`

---

## 五、测试清单

### 5.1 功能测试

- [ ] 用户签到功能正常
- [ ] 用户信息页面正常显示
- [ ] 签到记录页面正常显示
- [ ] 分页加载功能正常
- [ ] 日期筛选功能正常
- [ ] 页面跳转流畅
- [ ] 数据持久化正常

### 5.2 接口测试

- [ ] `/api/sign` 接口调用成功
- [ ] `/api/user/info` 接口调用成功
- [ ] `/api/sign/records` 接口调用成功
- [ ] 错误处理正常（网络错误、服务器错误等）

### 5.3 兼容性测试

- [ ] iOS 系统测试通过
- [ ] Android 系统测试通过
- [ ] 不同屏幕尺寸适配正常
- [ ] 不同网络环境下正常运行

---

## 六、发布流程

### 6.1 提交审核前检查

1. **代码检查**
   - [ ] 移除所有 console.log 调试代码
   - [ ] 确认 API 地址为生产环境地址
   - [ ] 确认版本号已更新

2. **资源检查**
   - [ ] 所有图片资源已优化
   - [ ] 无未使用的资源文件
   - [ ] 包体积控制在合理范围内（建议 < 2MB）

3. **功能检查**
   - [ ] 所有功能测试通过
   - [ ] 无明显Bug
   - [ ] 体验流畅

### 6.2 上传代码

1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 点击"上传"

### 6.3 提交审核

1. 登录微信公众平台
2. 进入"版本管理"
3. 在开发版本中选择刚上传的版本
4. 点击"提交审核"
5. 填写审核信息：
   - 功能描述
   - 测试账号（如果需要）
   - 截图/视频
6. 提交等待审核

### 6.4 发布上线

审核通过后：
1. 在"版本管理"中找到审核通过的版本
2. 点击"发布"
3. 确认发布

---

## 七、常见问题

### 7.1 网络请求失败

**问题**：调用接口时返回"网络请求失败"

**解决方案**：
1. 检查 API 基础地址是否正确
2. 确认后端服务是否启动
3. 检查微信小程序后台是否配置了服务器域名
4. 开发阶段勾选"不校验合法域名"

### 7.2 页面空白

**问题**：页面显示空白，无内容

**解决方案**：
1. 检查微信开发者工具控制台是否有错误
2. 确认页面路由配置是否正确
3. 检查 pages.json 配置
4. 确认组件语法是否正确

### 7.3 数据不刷新

**问题**：签到后数据不更新

**解决方案**：
1. 检查全局状态管理是否正常
2. 确认 API 返回数据格式是否正确
3. 检查页面生命周期函数（onShow）是否正常执行
4. 清除小程序缓存后重试

---

## 八、技术支持

### 8.1 相关文档

- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Vue 3 官方文档](https://cn.vuejs.org/)

### 8.2 开发工具

- [微信开发者工具下载](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- [HBuilderX 下载](https://www.dcloud.io/hbuilderx.html)

---

**配置文档版本**：v1.0  
**更新日期**：2026-02-04  
**适用版本**：君安否小程序 v1.0.0
