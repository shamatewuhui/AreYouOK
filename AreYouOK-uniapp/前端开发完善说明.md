# 君安否小程序 - 前端开发完善说明

## 一、完成内容概览

根据后端API接口文档，已完成前端开发的完善工作，主要包括以下内容：

### 1.1 核心功能模块
- ✅ 用户签到功能（首页）
- ✅ 用户信息展示页面
- ✅ 签到记录列表页面
- ✅ 全局状态管理
- ✅ API接口集成
- ✅ 数据持久化

### 1.2 新增文件清单

#### 页面文件
- `pages/user/info.vue` - 用户信息页面
- `pages/sign/records.vue` - 签到记录页面

#### 工具文件
- `utils/store.js` - 全局状态管理

#### 配置文件
- 已更新：`pages.json` - 页面路由配置
- 已更新：`utils/api.js` - API接口工具
- 已更新：`pages/index/index.vue` - 首页优化

---

## 二、详细功能说明

### 2.1 首页签到功能优化

**文件**：`pages/index/index.vue`

**新增功能**：
1. **用户信息快捷入口**
   - 显示用户昵称/姓名
   - 显示连续签到天数和累计签到天数
   - 点击跳转到用户信息页面

2. **底部功能按钮**
   - "签到记录"按钮，跳转到签到记录页面

3. **状态同步**
   - 签到成功后自动更新全局状态
   - 页面显示时自动刷新用户信息
   - 与后端API完全对接

**接口调用**：
- `POST /api/sign` - 用户签到
- `GET /api/user/info` - 获取用户信息（通过openid或email）

---

### 2.2 用户信息页面

**文件**：`pages/user/info.vue`

**功能特性**：
1. **用户信息展示**
   - 头像显示（支持微信头像）
   - 用户昵称
   - 邮箱地址
   - 邮箱验证状态标识

2. **签到统计卡片**
   - 连续签到天数
   - 累计签到天数
   - 最后签到时间（智能时间显示）

3. **功能操作**
   - 查看签到记录（跳转到记录页面）
   - 刷新用户信息
   - 返回首页

4. **状态管理**
   - 支持通过openid或email查询
   - 自动从全局状态或本地存储获取用户信息
   - 加载状态和错误状态处理

**接口调用**：
- `GET /api/user/info?openid={openid}` 
- `GET /api/user/info?email={email}`

**页面跳转**：
```javascript
// 从首页跳转
uni.navigateTo({
  url: '/pages/user/info'
})
```

---

### 2.3 签到记录页面

**文件**：`pages/sign/records.vue`

**功能特性**：
1. **签到记录列表**
   - 按时间倒序显示
   - 日期和时间分离显示
   - 签到状态图标

2. **日期筛选**
   - 开始日期选择
   - 结束日期选择
   - 自动刷新列表

3. **分页加载**
   - 默认每页20条记录
   - 上拉加载更多
   - 下拉刷新

4. **顶部统计**
   - 显示总签到记录数

5. **空状态处理**
   - 无记录时显示友好提示

**接口调用**：
- `GET /api/sign/records?openid={openid}&page=1&pageSize=20`
- `GET /api/sign/records?email={email}&startDate={startDate}&endDate={endDate}`

**页面跳转**：
```javascript
// 从用户信息页或首页跳转
uni.navigateTo({
  url: `/pages/sign/records?openid=${openid}&email=${email}`
})
```

---

### 2.4 全局状态管理

**文件**：`utils/store.js`

**功能说明**：
提供全局状态管理，使用单例模式，支持数据持久化。

**核心方法**：
```javascript
// 设置用户信息
store.setUserInfo(userInfo)

// 获取用户信息
const userInfo = store.getUserInfo()

// 检查登录状态
const isLogin = store.isUserLogin()

// 更新签到信息
store.updateSignInfo({
  signTime: '2026-02-03 14:30:00',
  continuousDays: 5,
  totalSignDays: 30
})

// 清除用户信息
store.clearUserInfo()
```

**数据结构**：
```javascript
{
  userInfo: {
    userId: 12345,
    openid: 'oUpF8uMuAJO_M2pxb1Q9zNjWeS6o',
    nickname: '张三',
    avatarUrl: 'https://...',
    email: 'zhangsan@example.com',
    emailVerified: false,
    lastSignTime: '2026-02-03 14:30:00',
    continuousDays: 5,
    totalSignDays: 30,
    status: 1
  },
  isLogin: true
}
```

---

### 2.5 API接口工具优化

**文件**：`utils/api.js`

**更新内容**：
1. 增强了 `getSignRecords()` 方法，支持完整的查询参数：
   - `openid` - 微信用户openid
   - `email` - 用户邮箱
   - `startDate` - 开始日期
   - `endDate` - 结束日期
   - `page` - 页码
   - `pageSize` - 每页数量

2. 新增 `getUserInfoByEmail()` 方法，支持通过邮箱查询用户信息

**使用示例**：
```javascript
import { signIn, getUserInfo, getUserInfoByEmail, getSignRecords } from '@/utils/api.js'

// 签到
const signResult = await signIn({
  name: '张三',
  email: 'zhangsan@example.com',
  openid: 'oUpF8uMuAJO_M2pxb1Q9zNjWeS6o'
})

// 获取用户信息（通过openid）
const userInfo = await getUserInfo('oUpF8uMuAJO_M2pxb1Q9zNjWeS6o')

// 获取用户信息（通过email）
const userInfo2 = await getUserInfoByEmail('zhangsan@example.com')

// 获取签到记录
const records = await getSignRecords({
  email: 'zhangsan@example.com',
  page: 1,
  pageSize: 20,
  startDate: '2026-02-01',
  endDate: '2026-02-03'
})
```

---

## 三、页面路由配置

**文件**：`pages.json`

已添加以下页面路由：

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "君安否"
      }
    },
    {
      "path": "pages/user/info",
      "style": {
        "navigationBarTitleText": "我的信息"
      }
    },
    {
      "path": "pages/sign/records",
      "style": {
        "navigationBarTitleText": "签到记录",
        "enablePullDownRefresh": true
      }
    }
  ]
}
```

---

## 四、数据流转说明

### 4.1 用户识别流程

```
用户打开小程序
    ↓
尝试从全局状态获取用户信息 (store.getUserInfo())
    ↓
如果没有，尝试从本地存储获取邮箱
    ↓
如果有邮箱，调用 API 获取用户信息
    ↓
保存到全局状态和本地存储
```

### 4.2 签到流程

```
用户填写姓名和邮箱
    ↓
点击"君安"按钮
    ↓
调用 /api/sign 接口
    ↓
签到成功后更新全局状态
    ↓
保存用户信息到本地
    ↓
显示签到成功提示
    ↓
刷新用户信息展示
```

### 4.3 页面跳转流程

```
首页 (pages/index/index)
    ↓
点击用户信息快捷入口 → 用户信息页 (pages/user/info)
    ↓
点击签到记录 → 签到记录页 (pages/sign/records)
```

---

## 五、后端接口对接清单

| 接口路径 | 方法 | 用途 | 对接页面 | 状态 |
|---------|------|------|---------|------|
| `/api/sign` | POST | 用户签到 | 首页 | ✅ 已对接 |
| `/api/user/info` | GET | 获取用户信息（openid） | 首页、用户信息页 | ✅ 已对接 |
| `/api/user/info` | GET | 获取用户信息（email） | 首页、用户信息页 | ✅ 已对接 |
| `/api/sign/records` | GET | 获取签到记录 | 签到记录页 | ✅ 已对接 |

---

## 六、本地存储说明

### 6.1 存储项

| 键名 | 类型 | 说明 |
|-----|------|------|
| `userName` | String | 用户姓名 |
| `userEmail` | String | 用户邮箱 |
| `userInfo` | JSON | 完整用户信息对象 |

### 6.2 存储时机

- 签到成功后保存 `userName` 和 `userEmail`
- 获取用户信息成功后保存完整的 `userInfo`
- 更新签到信息后更新 `userInfo`

---

## 七、UI/UX 特性

### 7.1 设计风格
- 温暖精致的配色方案
- 极简主义设计
- 流畅的过渡动画
- 友好的交互反馈

### 7.2 交互细节
- 按钮点击缩放效果
- 页面切换动画
- 加载状态提示
- 错误状态友好提示
- 空状态友好提示

### 7.3 响应式设计
- 适配不同屏幕尺寸
- 使用 rpx 单位
- 优化触摸区域

---

## 八、待配置项

### 8.1 API基础地址

**文件**：`utils/api.js`

```javascript
// 需要修改为实际的后端地址
const BASE_URL = 'https://your-api-domain.com/api'
```

### 8.2 默认头像

如果需要默认头像，需要在 `static` 目录下放置 `default-avatar.png` 文件。

**建议尺寸**：200x200 像素

**路径**：`/static/default-avatar.png`

---

## 九、开发和测试

### 9.1 本地开发

```bash
# 安装依赖
npm install

# 开发微信小程序
npm run dev:mp-weixin

# 构建微信小程序
npm run build:mp-weixin
```

### 9.2 测试要点

1. **签到功能测试**
   - 首次签到（创建新用户）
   - 重复签到（今日已签到提示）
   - 连续签到天数计算
   - 邮箱格式验证

2. **用户信息页面测试**
   - 用户信息正确显示
   - 刷新功能
   - 跳转到签到记录

3. **签到记录页面测试**
   - 记录列表显示
   - 分页加载
   - 下拉刷新
   - 日期筛选
   - 空状态显示

4. **状态管理测试**
   - 用户信息持久化
   - 页面间状态共享
   - 签到后状态更新

---

## 十、注意事项

### 10.1 微信小程序相关

1. **微信登录**
   - 目前代码中已预留微信登录接口调用
   - 需要配置小程序的 AppID 和 AppSecret
   - 后端需要实现 code 换取 openid 的接口

2. **网络请求域名**
   - 需要在微信小程序后台配置服务器域名
   - 必须使用 HTTPS 协议

### 10.2 数据安全

1. **用户隐私**
   - 邮箱信息加密存储
   - 敏感信息不在日志中输出

2. **接口安全**
   - 后端需要做好接口鉴权
   - 防止恶意请求

### 10.3 性能优化

1. **数据缓存**
   - 用户信息缓存到本地
   - 减少不必要的API调用

2. **图片优化**
   - 头像使用小尺寸
   - 考虑使用 CDN

---

## 十一、后续优化建议

### 11.1 功能增强
- [ ] 添加微信用户授权流程
- [ ] 实现签到日历视图
- [ ] 添加签到提醒设置
- [ ] 实现签到数据统计图表
- [ ] 添加签到分享功能

### 11.2 体验优化
- [ ] 添加骨架屏加载效果
- [ ] 优化动画效果
- [ ] 添加音效反馈
- [ ] 支持深色模式

### 11.3 稳定性提升
- [ ] 添加错误日志上报
- [ ] 优化网络请求重试机制
- [ ] 添加更完善的错误提示

---

## 十二、联系与支持

如有问题或建议，请联系开发团队。

**文档版本**：v1.0  
**更新日期**：2026-02-04
