# 姓名邮箱覆盖问题 - 修复逻辑流程图

## 整体流程

```mermaid
graph TD
    A[页面加载/显示] --> B{isFormDirty?}
    B -->|false 未修改| C[允许自动填充]
    B -->|true 已修改| D[保持当前值]
    
    C --> E[优先使用localStorage]
    E --> F[其次使用服务器数据]
    
    D --> G[用户继续编辑]
    
    H[用户输入] --> I[设置isFormDirty=true]
    I --> J[更新表单值]
    
    K[签到成功] --> L[保存到localStorage]
    L --> M[设置isFormDirty=false]
    M --> N[允许下次自动填充]
```

## 详细场景流程

### 场景1: 首次使用

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端页面
    participant L as localStorage
    participant S as 服务器
    
    U->>F: 打开小程序
    F->>L: 读取本地数据
    L-->>F: 无数据
    F->>U: 显示空表单
    
    U->>F: 输入姓名"张三"
    F->>F: isFormDirty = true
    
    U->>F: 输入邮箱"test001@qq.com"
    F->>F: isFormDirty = true
    
    U->>F: 点击签到
    F->>S: POST /api/sign {name:"张三", email:"test001@qq.com"}
    S-->>F: 签到成功
    F->>L: 保存"张三"+"test001@qq.com"
    F->>F: isFormDirty = false
    F->>U: 显示签到成功
```

### 场景2: 第二次打开(未修改)

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端页面
    participant L as localStorage
    
    U->>F: 打开小程序
    F->>F: isFormDirty = false (初始状态)
    F->>L: 读取本地数据
    L-->>F: "张三"+"test001@qq.com"
    F->>F: 因为isFormDirty=false,允许填充
    F->>U: 自动填充"张三"+"test001@qq.com"
```

### 场景3: 修改信息后签到(核心修复)

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端页面
    participant L as localStorage
    participant S as 服务器
    
    U->>F: 打开小程序
    F->>L: 读取本地数据
    L-->>F: "张三"+"test001@qq.com"
    F->>U: 自动填充"张三"+"test001@qq.com"
    
    U->>F: 修改姓名为"李四"
    F->>F: isFormDirty = true (关键!)
    
    U->>F: 修改邮箱为"test002@qq.com"
    F->>F: isFormDirty = true
    
    U->>F: 点击签到
    F->>S: POST /api/sign {name:"李四", email:"test002@qq.com"}
    S-->>F: 签到成功(或今日已签到)
    F->>L: 保存"李四"+"test002@qq.com"
    F->>F: isFormDirty = false
    
    Note over F: 调用loadUserInfo()时
    Note over F: 因为isFormDirty=false,但表单值已是最新
    Note over F: 所以不会被覆盖
    
    F->>U: 显示"李四"+"test002@qq.com"
```

### 场景4: 第三次打开(验证持久化)

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端页面
    participant L as localStorage
    
    U->>F: 关闭小程序
    Note over U,F: 时间流逝...
    
    U->>F: 重新打开小程序
    F->>F: isFormDirty = false (初始状态)
    F->>L: 读取本地数据
    L-->>F: "李四"+"test002@qq.com" (最新数据✅)
    F->>F: 因为isFormDirty=false,允许填充
    F->>U: 自动填充"李四"+"test002@qq.com"
    
    Note over U: ✅ 成功!显示的是最新数据
    Note over U: ❌ 不是旧数据"张三"+"test001@qq.com"
```

## 问题修复前的流程(有Bug)

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端页面
    participant S as 服务器
    
    U->>F: 打开小程序
    F->>S: 获取用户信息
    S-->>F: {nickname:"张三", email:"test001@qq.com"}
    F->>F: 无条件覆盖表单 (Bug!)
    F->>U: 显示"张三"+"test001@qq.com"
    
    U->>F: 修改为"李四"+"test002@qq.com"
    U->>F: 签到成功
    F->>S: 保存"李四"+"test002@qq.com"
    
    Note over F: onShow()触发,调用loadUserInfo()
    F->>S: 获取用户信息
    S-->>F: {nickname:"张三", email:"test001@qq.com"} (旧数据)
    F->>F: 无条件覆盖表单 (Bug!)
    F->>U: 显示"张三"+"test001@qq.com"
    
    Note over U: ❌ Bug!用户修改的数据被覆盖了
```

## 核心修复点

| 修复点 | 修复前 | 修复后 |
|--------|--------|--------|
| **表单状态** | 无状态跟踪 | 使用 `isFormDirty` 标记 |
| **自动填充** | 无条件覆盖 | 仅在 `isFormDirty=false` 时填充 |
| **数据优先级** | 服务器数据 | localStorage > 服务器数据 |
| **用户输入保护** | ❌ 无保护 | ✅ 输入时标记为已修改 |
| **签到后处理** | ❌ 可能被覆盖 | ✅ 清除标记但保持当前值 |

## 关键代码逻辑

### 输入时标记

```javascript
onNameInput(e) {
    this.formData.name = e.detail.value;
    this.isFormDirty = true;  // 🔑 关键:标记为已修改
    this.updateCanSign();
}
```

### 自动填充时检查

```javascript
loadUserInfo() {
    const storeUserInfo = store.getUserInfo();
    if (storeUserInfo) {
        this.userInfo = storeUserInfo;
        // 🔑 关键:只在未修改时才填充
        if (!this.isFormDirty) {
            const savedName = uni.getStorageSync('userName');
            const savedEmail = uni.getStorageSync('userEmail');
            this.formData.name = savedName || storeUserInfo.nickname || '';
            this.formData.email = savedEmail || storeUserInfo.email || '';
        }
        return;
    }
}
```

### 签到成功后清除标记

```javascript
doSignIn(openid) {
    signIn({ name, email, openid }).then(res => {
        this.saveUserInfo();
        // ... 更新全局状态
        
        // 🔑 关键:清除标记,允许下次自动填充
        // 但保持当前表单内容不变
        this.isFormDirty = false;
        
        this.loading = false;
    });
}
```

## 测试验证点

✅ **测试点1**: 用户修改后,表单不会被覆盖  
✅ **测试点2**: 关闭重开,显示最新数据  
✅ **测试点3**: localStorage优先于服务器数据  
✅ **测试点4**: 签到成功后,表单保持用户输入的值  

---

**备注**: 此流程图使用 Mermaid 语法,可以在支持 Mermaid 的 Markdown 编辑器中查看(如 Typora、VS Code等)。
